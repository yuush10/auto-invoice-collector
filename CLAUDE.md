# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview
WIP

This document provides guidelines for AI assistants working on this codebase, focusing on GAS-specific development practices and workflows.

## Critical Rules

### 1. Attribution & Commit Messages
**NEVER include AI references in:**
- Commit messages
- Pull request titles/descriptions
- Code comments
- Documentation

‚ùå **Prohibited:**
```bash
git commit -m "feat: Add feature (Generated by Claude)"
git commit -m "fix: Bug fix ü§ñ AI-assisted"
// Claude: This function handles...
```

‚úÖ **Required:**
```bash
git commit -m "feat: Add calendar sync functionality"
git commit -m "fix: Resolve timezone conversion errors"
// Initialize Calendar API with error handling
```

### 2. Git Workflow
```bash
# Always use feature branches
git checkout main && git pull
git checkout -b feature/description

# After work completion
git add . && git commit -m "type(scope): description"
git push origin feature/description
# Create PR on GitHub

# Cleanup after merge
git checkout main && git pull
git branch -d feature/description
git fetch --prune
```

**Branch Naming:**
- `feature/` - New features
- `fix/` - Bug fixes
- `docs/` - Documentation
- `refactor/` - Code refactoring
- `test/` - Test additions

### 3. Commit Message Format
Use conventional commits:
```
type(scope): subject

body (optional)

footer (optional)
```

Types: feat, fix, docs, style, refactor, test, chore

## Google Apps Script Development

### Project Structure
WIP

### Code Style for Apps Script
- Use modern JavaScript features (ES6+) supported by GAS runtime
- **Functions**: Use camelCase, start with verb (e.g., `getCalendarEvents`, `mirrorEvent`)
- **Constants**: Use UPPER_SNAKE_CASE in Config.js
- **Global variables**: Minimize use, prefer function parameters
- **Comments**: Use JSDoc format for function documentation
- **Error handling**: Always wrap API calls in try-catch blocks
- **Logging**: Use `Logger.log()` for development, `console.log()` for script execution logs

### Library Development (CRITICAL)

**IMPORTANT:** GAS libraries MUST use top-level function declarations. IIFE patterns do not work correctly:

‚úÖ **Correct (Top-level functions):**
```javascript
// CalendarEventHandler.js
function sync(config) {
  // Implementation
}

function mirrorEvent(srcEvent, targetCalendarId, options) {
  // Implementation
}
```

‚ùå **INCORRECT (IIFE - does not work in GAS libraries):**
```javascript
var CalendarEventHandler = (function() {
  function sync(config) { /* ... */ }
  return { sync: sync };
})();
```

**Why:** While IIFE syntax is valid JavaScript and runs in GAS, library functions wrapped in IIFE are not properly exposed to consuming projects. Only top-level function declarations are accessible when a project includes the library.

**Library Usage in Applications:**
```javascript
// In consuming project's appsscript.json
{
  "dependencies": {
    "libraries": [{
      "userSymbol": "CalendarEventHandler",
      "libraryId": "1xwM-WneWIb4pqJ7ogiT3daiUVNeuuBnR6Ci_SlUBm3T7K8w8gEFHMLxs",
      "version": "0",
      "developmentMode": true
    }]
  }
}

// Then call library functions with the userSymbol prefix
CalendarEventHandler.sync(config);
CalendarEventHandler.mirrorEvent(event, calendarId, options);
```

### Apps Script Specific Guidelines

#### Working with Calendar API
```javascript
// Get calendar by ID
const calendar = CalendarApp.getCalendarById(calendarId);

// Handle timezone conversions explicitly
const startTime = new Date(event.start.dateTime);
const timeZone = calendar.getTimeZone();

// Batch operations when possible
const events = calendar.getEvents(startDate, endDate);
```

#### Properties Service for Configuration
```javascript
// Store configuration in Script Properties
const scriptProps = PropertiesService.getScriptProperties();
scriptProps.setProperty('SOURCE_CALENDAR_ID', 'calendar@example.com');

// Use User Properties for user-specific data
const userProps = PropertiesService.getUserProperties();
```

#### Triggers
```javascript
// Time-based trigger setup
function createTimeDrivenTrigger() {
  ScriptApp.newTrigger('mirrorEvents')
    .timeBased()
    .everyHours(1)
    .create();
}

// Event-based trigger
function onCalendarUpdate(e) {
  // Handle calendar change event
}
```

#### Error Handling
```javascript
function safeApiCall(operation) {
  try {
    return operation();
  } catch (error) {
    console.error('Error: ' + error.message);
    Logger.log('Stack trace: ' + error.stack);
    // Notify admin or log to external service
    return null;
  }
}
```

### Development Workflow

#### Local Development with Clasp
```bash
# Install clasp globally (if not already installed)
npm install -g @google/clasp

# Login to Google account
clasp login

# Clone existing project
clasp clone <scriptId>

# Pull latest changes from Apps Script
clasp pull

# Push local changes to Apps Script
clasp push

# Open project in Apps Script editor
clasp open

# View logs
clasp logs
```

#### Testing
```javascript
// Create test functions with "test" prefix
function testMirrorEvent() {
  const testEvent = {
    summary: 'Test Event',
    start: { dateTime: new Date().toISOString() },
    end: { dateTime: new Date(Date.now() + 3600000).toISOString() }
  };

  const result = mirrorEvent(testEvent);
  Logger.log('Test result: ' + JSON.stringify(result));
}

// Run tests manually in Apps Script editor or via clasp
```

#### Deployment
```bash
# Create a new version
clasp version "Description of changes"

# Deploy as web app or API executable
clasp deploy --description "Production deployment"

# List deployments
clasp deployments
```

### Performance Considerations
- **Execution time limits**: GAS scripts timeout after 6 minutes (consumer) or 30 minutes (Workspace)
- **API quotas**: Calendar API has daily quotas (check Google Cloud Console)
- **Batch operations**: Group API calls to minimize execution time
- **Caching**: Use CacheService for frequently accessed data
```javascript
const cache = CacheService.getScriptCache();
cache.put('key', 'value', 21600); // Cache for 6 hours
```

### Security Best Practices
- **OAuth Scopes**: Declare minimal required scopes in appsscript.json
- **API Keys**: Use Script Properties, never hardcode
- **Calendar IDs**: Store in Properties Service
- **Validate inputs**: Check all event data before processing
- **Error messages**: Don't expose sensitive information in logs

### Common Tasks

#### Debugging
1. Use `Logger.log()` liberally during development
2. Check execution transcripts in Apps Script editor (View ‚Üí Executions)
3. Use `clasp logs` to view recent logs
4. Test edge cases: all-day events, recurring events, timezone differences

## AI Assistant Behavior

### When Writing Code
1. Focus on solving the problem efficiently within GAS constraints
2. Write clean, maintainable JavaScript code
3. Include try-catch blocks for all API calls
4. Add JSDoc comments for public functions
5. Follow GAS-specific conventions (camelCase for functions)

### When Responding
1. Be concise but complete
2. Provide working GAS examples
3. Explain quota and runtime implications
4. Suggest alternatives when appropriate
5. Ask for clarification if needed

### Context Optimization
Given limited context windows:
1. Prioritize relevant GAS documentation
2. Focus on current task
3. Reference Apps Script docs: https://developers.google.com/apps-script
4. Use code snippets judiciously

## Project-Specific Configuration

### appsscript.json Example
```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {
    "enabledAdvancedServices": [
      {
        "userSymbol": "Calendar",
        "version": "v3",
        "serviceId": "calendar"
      }
    ]
  },
  "oauthScopes": [
    "https://www.googleapis.com/auth/calendar",
    "https://www.googleapis.com/auth/calendar.events"
  ],
  "exceptionLogging": "STACKDRIVER"
}
```

## Remember
The goal is to create reliable, maintainable Apps Script code that efficiently mirrors calendar events. Focus on proper error handling, respecting API quotas, and creating a robust syncing mechanism. Always test thoroughly before deploying triggers.